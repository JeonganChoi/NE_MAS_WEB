{% extends "layouts/base.html" %}

{% block title %} 월 손익 계산서 {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

{% endblock stylesheets %}

{% block content %}

    <div class="px-5 py-4 container-fluid">
        <div class="row mt-n1">
            <div class="col-lg-1 col-1"></div>
            <div class="col-lg-10 col-10">
                <div class="card rounded-2 shadow-none bg-gradient-faded-info">
                    <div class="card-body">
                        <h5 class="mb-0 text-white font-weight-bold"><i class="fas fa-credit-card fas-4 me-3"></i>월 손익 계산서</h5>
                    </div>
                </div>
            </div>
            <div class="col-lg-1 col-1"></div>
        </div>
        <div class="row mt-4">
            <div class="col-lg-1 col-1"></div>
            <div class="col-lg-10 col-10">
                <div class="card">
                    <div class="card-header border border-light border-top-0 border-end-0 border-start-0 pb-0">
                        <div class="row">
                            <div class="col-lg-3 col-3 text-start">
                              <div class="input-group shadow-none">
                                  <label class="mt-1 me-4" style="font-size: 0.85rem; width: 5rem" for="inputStrDate"><i class="fas fa-search me-2"></i>년월</label>
                                  <input class="form-control border border-light rounded-1 text-center me-2" type="month" name="inputYM" id="inputYM" style="max-width: 8rem;height: 2rem; font-size: 0.8rem">
                              </div>
                            </div>
                            <div class="col-lg-1 col-1 text-end">
                              <button type="button" class="btn btn-sm btn-info" id="btnSearch" name="btnSearch"><i class="fas fa-search me-2"></i>조회</button>
                            </div>
                        </div>
                    </div>
                    <div class="px-0 py-0 card-body">
                        <div class="row">
                            <div class="col-lg-9 col-9">
                                <div class="m-2 table-responsive-sm overflow-auto" style="height: 60vh">
                                    <table class="table mb-0 align-items-center justify-content-center">
                                        <colgroup>
                                            <col width="8%"/>
                                            <col width="8%"/>
                                            <col width="8%"/>
                                            <col width="8%"/>
                                            <col width="15%"/>
                                        </colgroup>
                                        <thead id="headTb">
                                        <tr id="#headTr" class="headTr_tr">

                                        </tr>
                                        </thead>
                                        <tbody id="sheetTb">
                                          <tr id="#sheetTr" class="sheetTr_tr">

                                          </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block javascripts %}
    <script>
        $(document).ready(function () {

            date = new Date();
            var year = date.getFullYear().toString();
            var month = (date.getMonth()+1).toString();
            month = month.padStart(2, '0')
            var fdate = year + month
            document.getElementById("inputYM").value = fdate.replace(/(\d{4})(\d{2})/g, '$1-$2');

            var input = document.getElementById('inputYM').value
            var ym = input.replace(/\-/g, '')
            var yyyy = ym.slice(0,4);
            var mm = ym.slice(4,6);
            var dd = date.getDate()

            var data = {'ym': ym, 'yyyy': yyyy, 'mm': mm}

            $.ajax({
            type: "post",
            data: data,
            url: '{% url "monthly_profit_loss_search" %}',
            headers: {
                'X-CSRFTOKEN': '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function (data) {
                /* var list = data.mheadList;
                var list2 = data.headList;
                var list3 = data.mainList;
                var sale = 0;

                $("#headTb").html("");
                $("#sheetTb").html("");

                $("#headTb").append("<tr id='#headTr' class='headTr_tr'>" +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem' colspan='6'>" + mm + "월</th> " +
                    "</tr> ");

                $("#headTb").append("<tr id='#headTr' class='headTr_tr'>" +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>항목</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>금액</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>매출 대비</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>일평균</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>비 고</th> " +
                    "</tr> ");

                {# 왼쪽 남색 큰 카테코리#}
                for (var i = 0; i < list.length; i++) {
                    $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" +
                        "<td class='text-center bg-dark text-white border border-light p-1' style='font-size: 0.85rem'>" + list3[i][1] + "</td> " +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td> " +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td> " +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td>" +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td>" +
                        "</tr> ");

                    {# 왼쪾 회색 작은 카테고리#}
                    for (var d = 0; d < list3.length; d++) {
                        if(list3[d][0] == '1'){
                            sale += list3[d][4]
                        }

                        if(list[i][0] == list3[d][0]){
                        var price = 0;
                        price += list3[d][4]
                            $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" +
                                "<td class='text-start bg-dark text-white border border-light p-1' style='font-size: 0.85rem'>" + list3[d][1] + "</td> " +
                                "<td class='text-end border border-light p-1' style='font-size: 0.85rem'>" + addComma(price) + "</td> " +
                                "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + (Math.round((price / sale) * 100).toFixed(2)) + "%</td> " +
                                "<td class='text-end border border-light p-1' style='font-size: 0.85rem'>" + addComma((Math.round(price / dd))) + "</td>" +
                                "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + list3[d][3] + "</td>" +
                                "</tr> ");

                            $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" +
                                "<td class='text-start bg-gray-700 text-white border border-light p-1' style='font-size: 0.85rem'>" + list3[d][3] + "</td> " +
                                "<td class='text-end border border-light p-1' style='font-size: 0.85rem'>" + addComma(list3[d][4]) + "</td> " +
                                "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + (Math.round((list3[d][4] / sale) * 100).toFixed(2)) + "%</td> " +
                                "<td class='text-end border border-light p-1' style='font-size: 0.85rem'>" + addComma(list3[d][5]) + "</td>" +
                                "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td>" +
                                "</tr> ");
                        }
                    }
                }*/

                var list = data.mheadList;
                var list2 = data.headList;
                var list3 = data.mainList;

                $("#headTb").html("");
                $("#sheetTb").html("");

                $("#headTb").append("<tr id='#headTr' class='headTr_tr'>" +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem' colspan='6'>" + mm + "월</th> " +
                    "</tr> ");

                $("#headTb").append("<tr id='#headTr' class='headTr_tr'>" +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>항목</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>금액</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>매출 대비</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>일평균</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>비 고</th> " +
                    "</tr> ");


                for (var d = 0; d < list3.length; d++) {
                    let $sheetTr_tr_title = $(`.sheetTr_tr_title_${list3[d][0]}`);
                    let sheetTr_tr_title_len = $sheetTr_tr_title.length;

                    if(sheetTr_tr_title_len == 0) {
                        $("#sheetTb").append("<tr id='sheetTr' class='sheetTr_tr_title_" + list3[d][0] + "'>" +
                            "<td class='text-center bg-dark text-white border border-light p-1' style='font-size: 0.85rem'>" + list3[d][1] + "</td> " +
                            "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td> " +
                            "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td> " +
                            "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td>" +
                            "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + list3[d][3] + "</td>" +
                            "</tr> ");
                    } else {
                        let remarks = $sheetTr_tr_title.children().eq(4).text();
                        let new_remarks = remarks + ',' + list3[d][3];

                        $sheetTr_tr_title.children().eq(4).text(new_remarks);
                    }

                    var sale = 0;
                    if(list3[d][0] == '1'){
                        sale += list3[d][4]
                    }

                    $("#sheetTb").append("<tr id='sheetTr' class='sheetTr_tr_" + list3[d][0] + "'>" +
                        "<td class='text-center bg-gray-700 text-white border border-light p-1' style='font-size: 0.85rem'>" + list3[d][3] + "</td> " +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + addComma(list3[d][4]) + "</td> " +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + (Math.round((list3[d][4]/ sale) * 100).toFixed(2)) + "%</td> " +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + addComma(list3[d][5]) + "</td>" +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td>" +
                        "</tr> ");

                    let $sheetTr_tr = $(`.sheetTr_tr_${list3[d][0]}`);
                    let sheetTr_tr_len = $sheetTr_tr.length;

                    if(sheetTr_tr_len > 0) {
                        let children = $(`.sheetTr_tr_title_${list3[d][0]}`).children();
                        let child_1 = children.eq(1);
                        let child_2 = children.eq(2);
                        let child_3 = children.eq(3);

                        let new_value_1 = 0;
                        let new_value_2 = 0;
                        let new_value_3 = 0;

                        for(let i=0; i<sheetTr_tr_len; i++) {
                            new_value_1 += Number($sheetTr_tr.eq(i).children().eq(1).text().replace(/\D/g, ""));
                            new_value_2 += Number($sheetTr_tr.eq(i).children().eq(2).text().replace(/\D/g, ""));
                            new_value_3 += Number($sheetTr_tr.eq(i).children().eq(3).text().replace(/\D/g, ""));
                        }

                        child_1.text(addComma(new_value_1));
                        child_2.text(new_value_2 + "%");
                        child_3.text(addComma(new_value_3));
                    }
                }

                }
            })
        });

        {# 조회 버튼 누를시 #}
        $(document).on('click', '#btnSearch', function () {
            var input = document.getElementById('inputYM').value
            var ym = input.replace(/\-/g, '')
            var yyyy = ym.slice(0,4);
            var mm = ym.slice(4,6);

            var data = {'ym': ym, 'yyyy': yyyy, 'mm': mm}

            $.ajax({
            type: "post",
            data: data,
            url: '{% url "monthly_profit_loss_search" %}',
            headers: {
                'X-CSRFTOKEN': '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function (data) {
                var list = data.mheadList;
                var list2 = data.headList;
                var list3 = data.mainList;

                $("#headTb").html("");
                $("#sheetTb").html("");

                $("#headTb").append("<tr id='#headTr' class='headTr_tr'>" +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem' colspan='6'>" + mm + "월</th> " +
                    "</tr> ");

                $("#headTb").append("<tr id='#headTr' class='headTr_tr'>" +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>항목</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>금액</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>매출 대비</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>일평균</th> " +
                    "<th class='text-center bg-dark border border-top text-white p-1' style='font-size: 0.85rem; width: 3rem'>비 고</th> " +
                    "</tr> ");


                for (var d = 0; d < list3.length; d++) {
                    {#상위 세팅#}
                    let $sheetTr_tr_title = $(`.sheetTr_tr_title_${list3[d][0]}`);
                    let sheetTr_tr_title_len = $sheetTr_tr_title.length;

                    if(sheetTr_tr_title_len == 0) {
                        $("#sheetTb").append("<tr id='sheetTr' class='sheetTr_tr_title_" + list3[d][0] + "'>" +
                            "<td class='text-center bg-dark text-white border border-light p-1' style='font-size: 0.85rem'>" + list3[d][1] + "</td> " +
                            "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td> " +
                            "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td> " +
                            "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td>" +
                            "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + list3[d][3] + "</td>" +
                            "</tr> ");

                        {#환급금#}
                    } else {
                        let remarks = $sheetTr_tr_title.children().eq(4).text();
                        let new_remarks = remarks + ',' + list3[d][3]; {#환급금,수입이자#}

                        $sheetTr_tr_title.children().eq(4).text(new_remarks);
                    }

                    var sale = 0;
                    if(list3[d][0] == '1'){
                        sale += list3[d][4]
                    }

                    {#하위세팅#}
                    $("#sheetTb").append("<tr id='sheetTr' class='sheetTr_tr_" + list3[d][0] + "'>" +
                        "<td class='text-center bg-gray-700 text-white border border-light p-1' style='font-size: 0.85rem'>" + list3[d][3] + "</td> " +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + addComma(list3[d][4]) + "</td> " +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + (Math.round((list3[d][4] / sale) * 100).toFixed(2)) + "%</td> " +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'>" + addComma(list3[d][5]) + "</td>" +
                        "<td class='text-center border border-light p-1' style='font-size: 0.85rem'></td>" +
                        "</tr> ");

                    let $sheetTr_tr = $(`.sheetTr_tr_${list3[d][0]}`);
                    let sheetTr_tr_len = $sheetTr_tr.length;

                    if(sheetTr_tr_len > 0) {
                        let children = $(`.sheetTr_tr_title_${list3[d][0]}`).children();
                        let child_1 = children.eq(1); {# 금액 #}
                        let child_2 = children.eq(2); {# 매출대비 #}
                        let child_3 = children.eq(3); {# 일평균 #}

                        let new_value_1 = 0;
                        let new_value_2 = 0;
                        let new_value_3 = 0;

                        for(let i=0; i<sheetTr_tr_len; i++) {
                            new_value_1 += Number($sheetTr_tr.eq(i).children().eq(1).text().replace(/\D/g, ""));
                            new_value_2 += Number($sheetTr_tr.eq(i).children().eq(2).text().replace(/\D/g, ""));
                            new_value_3 += Number($sheetTr_tr.eq(i).children().eq(3).text().replace(/\D/g, ""));
                        }

                        child_1.text(addComma(new_value_1));
                        child_2.text(new_value_2 + "%");
                        child_3.text(addComma(new_value_3));
                    }
                }
                }
            })
        });
    </script>
{% endblock %}