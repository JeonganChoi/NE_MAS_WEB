{% extends "layouts/base.html" %}

{% block title %} 손익 현황 {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

{% endblock stylesheets %}

{% block content %}

    <div class="px-5 py-4 container-fluid">
        <div class="row mt-n1">
            <div class="col-lg-1 col-1"></div>
            <div class="col-lg-10 col-10">
                <div class="card bg-gradient-primary">
                    <div class="card-body bg-transparent">
                        <h5 class="mb-0 text-white font-weight-bold"><i class="fas fa-credit-card fas-4 me-3"></i>손익 현황</h5>
                    </div>
                </div>
            </div>
            <div class="col-lg-1 col-1"></div>
        </div>
        <div class="row mt-4">
            <div class="col-lg-1 col-1"></div>
            <div class="col-lg-10 col-10">
                <div class="card border shadow-xs">
                    <div class="card-header border border-light border-top-0 border-end-0 border-start-0 pb-0">
                        <div class="row">
                            <div class="col-lg-4 col-4 text-start">
                              <div class="input-group shadow-none">
                                  <label class="me-4" style="font-size: 0.85rem; width: 5rem"><i class="fas fa-search me-2"></i>적용 년월</label>
                                  <input class="form-control border border-light rounded-1 text-center me-2" type="month" name="strYM" id="strYM" style="max-width: 8rem;height: 2rem; font-size: 0.8rem">
                                  <label class="" style="font-size: 0.85rem; width: 1rem">-</label>
                                  <input class="form-control border border-light rounded-1 text-center me-2" type="month" name="endYM" id="endYM" style="max-width: 8rem;height: 2rem; font-size: 0.8rem">
                              </div>
                            </div>
                            <div class="col-lg-2 col-2 text-start">
                              <button type="button" class="btn btn-sm btn-info" id="btnSearch" name="btnSearch"><i class="fa fa-search fs-6 me-2"></i>조회</button>
                            </div>
                        </div>
                    </div>
                    <div class="px-0 py-0 card-body">
                        <div class="row">
                            <div class="col-lg-12 col-12">
                                <div class="m-2 table-responsive-sm overflow-auto height-500">
                                    <table class="table mb-0 align-items-center justify-content-center">
                                        <thead id="headTb" style="background-color: rgb(0, 92, 151); position: sticky; top: 0">
                                        <tr id="#headTr" class="headTr_tr">

                                        </tr>
                                        </thead>
                                        <tbody id="sheetTb">
                                          <tr id="#sheetTr" class="sheetTr_tr">

                                          </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block javascripts %}
    <script>

        $(document).ready(function () {

            var total = 0;
            var total2 = 0;
            var total3 = 0;
            var total4 = 0;
            var total5 = 0;
            var total6 = 0;
            var total7 = 0;
            var total8 = 0;
            var pnt = 100;
            var date = new Date();
            date.setMonth(date.getMonth() - 3);
            {#var year = date.getFullYear()#}
            {#var monthT = date.setMonth(date.getMonth() + 1)#}
            {#var monthF = date.setMonth(date.getMonth() - 2)#}
            {#var fdate = year + "-" +  monthF#}
            {#var tdate = year + "-" + monthT#}
            document.getElementById("strYM").valueAsDate = date;
            document.getElementById("endYM").valueAsDate = new Date();


            var strDate = document.getElementById('strYM').value
            var sDate = strDate.replace("-", "")
            var year = sDate.substr(0,4)
            sDate = parseInt(sDate.substr(4,2))
            var endDate = document.getElementById('endYM').value
            var eDate = endDate.replace("-", "")
            eDate = parseInt(eDate.substr(4,2)) + 1

            {# eDate 값이 sDate값이 작아서 for문이 돌지않음 #}
            var monthArr = [];
            for (var i = sDate; i < eDate; i++) {

                if(i < 10){ i = '0' + i}
                var month = year.concat(i);

                let data = {
                    'month': month,
                };
                monthArr.push(data);
            }

            $.ajax({
                type: "post",
                data: {
                    "strDate": strDate,
                    "endDate": endDate,
                    'monthArrList': JSON.stringify(monthArr),
                },
                url: '{% url "monthly_profit_loss_search" %}',
                headers: {
                    'X-CSRFTOKEN': '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function (data) {
                    var list = data.mCodeList;
                    var list2 = data.aCodeList;
                    var list3 = data.monthListM;
                    var list4 = data.monthListA;
                    var saleTotal = 0;
                    var percent = 0;

                    {#수정했음#}
                    var dates = getYearMonthsBetween(strDate, endDate);

                    $("#headTb").html("");
                    $("#sheetTb").html("");

                    $("#headTb").append("<tr id='#headTr' class='headTr_tr'>" + "</tr> ");
                    $("#headTb").append(
                        "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' rowspan='2' colspan='2'>과 목</th> " +
                        "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' rowspan='2'>합 계</th> + " +
                        "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' rowspan='2'>점유율</th> ");

                    {# 헤더 월수 뿌려주는 곳 #}
                    for (var d = 0; d < dates.length; d++) {

                        {#수정했음#}
                        var mm = String(dates[d]).substr(4, 2);

                        {#d를 mm으로 수정했음#}
                        $("#headTb").append(

                            "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' colspan='2' value='" + mm + "'>" + mm + "월</th> ");
                    }

                    $("#headTb").append("<tr id='#headTr' class='headTr_tr'>" + "</tr> ");
                    $("#headTb").append(
                        "<th class='p-1' style='font-size: 0.85rem'></th> " +
                        "<th class='p-1' style='font-size: 0.85rem'></th> " +
                        "<th class='p-1' style='font-size: 0.85rem'></th>" +
                        "<th class='p-1' style='font-size: 0.85rem'></th> ")

                    {#수정했음#}
                    for (var d = 0; d < dates.length; d++) {
                        $("#headTb").append(
                            "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' >합 계</th> " +
                            "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' >점유율</th> ");
                    }

                    for (var i = 0; i < list.length; i++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list[i][0] == '401'){
                            $("#sheetTb").append(
                            "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>매출액</td> " +
                            "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                            "<td class='text-end border border-light text-dark p-1 salesamount_sum' style='font-size: 0.85rem'>" + addComma(list[i][2]) + "</td>" +
                            "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + percent + "%</td> ");

                            for (var d = 0; d < dates.length; d++) {

                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list[i][0]}_${dates[d]} salesamount_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0%</td> `);
                            }
                        }
                        if(list[i][0] != '401'){
                            $("#sheetTb").append(
                            "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>매출액</td> " +
                            "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                            "<td class='text-end border border-light text-dark p-1 salesamount_sum' style='font-size: 0.85rem'>0</td>" +
                            "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + percent + "%</td> ");

                            for (var d = 0; d < dates.length; d++) {

                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 salesamount_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0%</td> `);
                            }
                        }
                        total = parseInt(list[i][2]);
                        saleTotal = parseInt(list[i][2]);
                    }

                    for (var j = 0; j < list2.length; j++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list2[j][0] == '401' && list2[j][3] > 0){
                            $("#sheetTb").append(
                            "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                            "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>" + list2[j][2] + "</td> " +
                            "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list2[j][3]) + "</td> " +
                            "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list2[j][0]}_${list2[j][1]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 ' style='font-size: 0.85rem'>매출대비</td> `);
                            }

                        }
                    }

                    for (var i = 0; i < list.length; i++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list[i][0] == '501') {
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>매출 원가</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list[i][2]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {

                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list[i][0]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }
                        if(list[i][0] != '501'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>매출 원가</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            pnt = Math.ceil(total2 * 100) / total
                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }

                        total2 = parseInt(list[i][2])
                    }

                    for (var j = 0; j < list2.length; j++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list2[j][0] == '501' && list2[j][3] > 0){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>" + list2[j][2] + "</td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list2[j][3]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = parseInt(strDate); d <= parseInt(endDate); d++){
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list2[j][0]}_${list2[j][1]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                            }
                        }
                    }

                    {# 매출총이익 #}
                    total3 = parseInt(total) - parseInt(total2)
                    $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                    $("#sheetTb").append(
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'>매출총이익</td> " +
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'></td> " +
                        "<td class='text-end border border-light text-info p-1 profit profit_sum' style='font-size: 0.85rem'>" + addComma(total3) + "</td> " +
                        "<td class='text-end border border-light text-info p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                    for (var d = 0; d < dates.length; d++) {
                        $("#sheetTb").append(
                            `<td class='text-end border border-light text-info p-1 profit profit_${dates[d]}' style='font-size: 0.85rem'>0</td>
                            <td class='text-end border border-light text-info p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                    }

                    for (var i = 0; i < list.length; i++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list[i][0] == '502'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>판매비와관리비</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1 sale_mng_fee sale_mng_fee_sum' style='font-size: 0.85rem'>" + addComma(list[i][2]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {

                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 sale_mng_fee sale_mng_fee_${dates[d]} ${list[i][0]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }

                        }

                        if(list[i][0] != '502'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>판매비와관리비</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }
                        total4 = parseInt(list[i][2])
                    }


                    {# 판매비와 관리비 밑에줄들 #}
                    for (var j = 0; j < list2.length; j++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list2[j][0] == '502' && list2[j][3] > 0){

                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>" + list2[j][2] + "</td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list2[j][3]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");


                            {#수정했음#}
                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list2[j][0]}_${list2[j][1]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                            }

                        }
                    }

                    {# 영업이익 #}
                    total5 = parseInt(total3) + parseInt(total4)
                    $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                    $("#sheetTb").append(
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'>영업이익</td> " +
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'></td> " +
                        "<td class='text-end border border-light text-info p-1 sale_revenue sale_revenue_sum' data-ym='sum' style='font-size: 0.85rem'>" + addComma(total5) + "</td> " +
                        "<td class='text-end border border-light text-info p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                    for (var d = 0; d < dates.length; d++) {
                        $("#sheetTb").append(
                            `<td class='text-end border border-light text-info p-1 sale_revenue sale_revenue_${dates[d]}' data-ym='${dates[d]}' style='font-size: 0.85rem'>0</td>
                            <td class='text-end border border-light text-info p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                    }

                    {# 영업외수익 #}
                    for (var i = 0; i < list.length; i++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list[i][0] == '402'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>영업외수익</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1 in_mng_fee in_mng_fee_sum' style='font-size: 0.85rem'>" + addComma(list[i][2]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 in_mng_fee in_mng_fee_${dates[d]} ${list[i][0]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }
                        if(list[i][0] != '402'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>영업외수익</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }

                        total6 = parseInt(list[i][2])
                    }


                    for (var j = 0; j < list2.length; j++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list2[j][0] == '402' && list2[j][6] > 0){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>" + list2[j][5] + "</td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list2[j][6]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list2[j][0]}_${list2[j][1]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                            }
                        }
                    }


                    {# 영업외비용 #}
                    for (var i = 0; i < list.length; i++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list[i][0] == '503'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>영업외비용</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1 out_mng_fee out_mng_fee_sum' style='font-size: 0.85rem'>-" + addComma(list[i][2]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 out_mng_fee out_mng_fee_${dates[d]} ${list[i][0]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }
                        if(list[i][0] != '503'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>영업외비용</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }

                        total7 = parseInt(list[i][2])
                    }


                    for (var j = 0; j < list2.length; j++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list2[j][0] == '503' && list2[j][3] > 0){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>" + list2[j][2] + "</td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list2[j][3]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");


                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list2[j][0]}_${list2[j][1]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                            }
                        }
                    }

                    {# 순이익 #}
                    total8 = total5 + total6 - total7
                    $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                    $("#sheetTb").append(
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'>순이익</td> " +
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'></td> " +
                        "<td class='text-end border border-light text-info p-1 profit_revenue profit_revenue_sum' data-ym='sum' style='font-size: 0.85rem'>" + addComma(total8) + "</td> " +
                        "<td class='text-end border border-light text-info p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                    for (var d = 0; d < dates.length; d++) {
                        $("#sheetTb").append(
                            `<td class='text-end border border-light text-dark p-1 profit_revenue profit_revenue_${dates[d]}' data-ym='${dates[d]}' style='font-size: 0.85rem'>합계</td>
                             <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                    }

                    {#수정했음#}
                    for (var k = 0; k < list3.length; k++) {
                        $(`.${list3[k][0]}_${list3[k][3]}`).text(addComma(list3[k][2]));
                    }
                    for (var k = 0; k < list4.length; k++) {
                        $(`.${list4[k][0]}_${list4[k][1]}_${list4[k][4]}`).text(addComma(list4[k][3]));
                    }

                    $('.sale_revenue').each(function() {
                        var ym = $(this).data('ym');

                        var profit = parseInt($(`.profit_${ym}`).text().replaceAll(',', ''));
                        var sale_mng_fee = isNaN(parseInt($(`.sale_mng_fee_${ym}`).text())) ? 0 : parseInt($(`.sale_mng_fee_${ym}`).text().replaceAll(',', ''));
                        var sale_revenue = profit + sale_mng_fee;

                        $(this).text(addComma(sale_revenue));
                    });

                    $('.profit_revenue').each(function() {
                        var ym = $(this).data('ym');
                        var profit = 0;
                        var sale_mng_fee = 0;
                        var in_mng_fee = 0;
                        var out_mng_fee = 0;
                        var profit_revenue = 0;

                        if($(`.profit_${ym}`).length > 0)
                            profit = parseInt($(`.profit_${ym}`).text().replaceAll(',', ''));

                        if($(`.sale_mng_fee_${ym}`).length > 0)
                            sale_mng_fee = parseInt($(`.sale_mng_fee_${ym}`).text().replaceAll(',', ''));

                        if($(`.in_mng_fee_${ym}`).length > 0)
                            in_mng_fee = parseInt($(`.in_mng_fee_${ym}`).text().replaceAll(',', ''));

                        if($(`.out_mng_fee_${ym}`).length > 0)
                            out_mng_fee = parseInt($(`.out_mng_fee_${ym}`).text().replaceAll(',', ''));

                        profit_revenue = profit + sale_mng_fee + in_mng_fee - out_mng_fee;

                        $(this).text(addComma(profit_revenue));
                    });

                    {# 점유율 계산 #}
                    {#  각 항목의 합계에 매출액 합계로 나눠서 100 #}
                    $('.sharerate').each(function() {
                        var ym = $(this).data('ym');
                        var salesamount = 0;
                        var sub_sum = 0;
                        var sharerate = 0;

                        if($(`.salesamount_${ym}`).length > 0)
                            salesamount = parseInt($(`.salesamount_${ym}`).text().replaceAll(',', ''));

                        if($(this).prev())
                            sub_sum = parseInt($(this).prev().text().replaceAll(',', ''));

                        if(salesamount != 0)
                            sharerate = sub_sum / salesamount * 100;

                        $(this).text(addComma(sharerate.toFixed(2)) + '%');
                    });



                }
            });
        });

        {# 조회 버튼 누를시 #}
        $(document).on('click', '#btnSearch', function () {
            var total = 0;
            var total2 = 0;
            var total3 = 0;
            var total4 = 0;
            var total5 = 0;
            var total6 = 0;
            var total7 = 0;
            var total8 = 0;
            var pnt = 100;

            var strDate = document.getElementById('strYM').value
            var sDate = strDate.replace("-", "")
            var year = sDate.substr(0,4)
            sDate = parseInt(sDate.substr(4,2))
            var endDate = document.getElementById('endYM').value
            var eDate = endDate.replace("-", "")
            eDate = parseInt(eDate.substr(4,2)) + 1


            var monthArr = [];
            for (var i = sDate; i < eDate; i++) {

                if(i < 10){ i = '0' + i}
                var month = year.concat(i);

                let data = {
                    'month': month,
                };
                monthArr.push(data);
            }

            $.ajax({
                type: "post",
                data: {
                    "strDate": strDate,
                    "endDate": endDate,
                    'monthArrList': JSON.stringify(monthArr),
                },
                url: '{% url "monthly_profit_loss_search" %}',
                headers: {
                    'X-CSRFTOKEN': '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function (data) {
                    var list = data.mCodeList;
                    var list2 = data.aCodeList;
                    var list3 = data.monthListM;
                    var list4 = data.monthListA;
                    var saleTotal = 0;
                    var percent = 0;


                    {#수정했음#}
                    var dates = getYearMonthsBetween(strDate, endDate);

                    $("#headTb").html("");
                    $("#sheetTb").html("");

                    $("#headTb").append("<tr id='#headTr' class='headTr_tr'>" + "</tr> ");
                    $("#headTb").append(
                        "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' rowspan='2' colspan='2'>과 목</th> " +
                        "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' rowspan='2'>합 계</th> + " +
                        "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' rowspan='2'>점유율</th> ");

                    {#for (var d = parseInt(strDate); d <= parseInt(endDate); d++)#}
                    for (var d = 0; d < dates.length; d++) {

                        {#수정했음#}
                        var mm = String(dates[d]).substr(4, 2);

                        {#d를 mm으로 수정했음#}
                        $("#headTb").append(

                            "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' colspan='2' value='" + mm + "'>" + mm + "월</th> ");
                    }

                    $("#headTb").append("<tr id='#headTr' class='headTr_tr'>" + "</tr> ");
                    $("#headTb").append(
                        "<th class='p-1' style='font-size: 0.85rem'></th> " +
                        "<th class='p-1' style='font-size: 0.85rem'></th> " +
                        "<th class='p-1' style='font-size: 0.85rem'></th>" +
                        "<th class='p-1' style='font-size: 0.85rem'></th> ")

                    {#수정했음#}
                    for (var d = 0; d < dates.length; d++) {
                        $("#headTb").append(
                            "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' >합 계</th> " +
                            "<th class='text-center border border-light text-white p-1' style='font-size: 0.85rem' >점유율</th> ");
                    }

                    for (var i = 0; i < list.length; i++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list[i][0] == '401'){
                            $("#sheetTb").append(
                            "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>매출액</td> " +
                            "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                            "<td class='text-end border border-light text-dark p-1 salesamount_sum' style='font-size: 0.85rem'>" + addComma(list[i][2]) + "</td>" +
                            "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + percent + "%</td> ");

                            for (var d = 0; d < dates.length; d++) {

                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list[i][0]}_${dates[d]} salesamount_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0%</td> `);
                            }
                        }
                        if(list[i][0] != '401'){
                            $("#sheetTb").append(
                            "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>매출액</td> " +
                            "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                            "<td class='text-end border border-light text-dark p-1 salesamount_sum' style='font-size: 0.85rem'>0</td>" +
                            "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + percent + "%</td> ");

                            for (var d = 0; d < dates.length; d++) {

                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 salesamount_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0%</td> `);
                            }
                        }
                        total = parseInt(list[i][2]);
                        saleTotal = parseInt(list[i][2]);
                    }

                    for (var j = 0; j < list2.length; j++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list2[j][0] == '401' && list2[j][3] > 0){
                            $("#sheetTb").append(
                            "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                            "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>" + list2[j][2] + "</td> " +
                            "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list2[j][3]) + "</td> " +
                            "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list2[j][0]}_${list2[j][1]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 ' style='font-size: 0.85rem'>매출대비</td> `);
                            }

                        }
                    }

                    for (var i = 0; i < list.length; i++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list[i][0] == '501') {
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>매출 원가</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list[i][2]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {

                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list[i][0]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }
                        if(list[i][0] != '501'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>매출 원가</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            pnt = Math.ceil(total2 * 100) / total
                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }

                        total2 = parseInt(list[i][2])
                    }

                    for (var j = 0; j < list2.length; j++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list2[j][0] == '501' && list2[j][3] > 0){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>" + list2[j][2] + "</td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list2[j][3]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = parseInt(strDate); d <= parseInt(endDate); d++){
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list2[j][0]}_${list2[j][1]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                            }
                        }
                    }

                    {# 매출총이익 #}
                    total3 = parseInt(total) - parseInt(total2)
                    $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                    $("#sheetTb").append(
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'>매출총이익</td> " +
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'></td> " +
                        "<td class='text-end border border-light text-info p-1 profit profit_sum' style='font-size: 0.85rem'>" + addComma(total3) + "</td> " +
                        "<td class='text-end border border-light text-info p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                    for (var d = 0; d < dates.length; d++) {
                        $("#sheetTb").append(
                            `<td class='text-end border border-light text-info p-1 profit profit_${dates[d]}' style='font-size: 0.85rem'>0</td>
                            <td class='text-end border border-light text-info p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                    }

                    for (var i = 0; i < list.length; i++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list[i][0] == '502'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>판매비와관리비</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1 sale_mng_fee sale_mng_fee_sum' style='font-size: 0.85rem'>" + addComma(list[i][2]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {

                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 sale_mng_fee sale_mng_fee_${dates[d]} ${list[i][0]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }

                        }

                        if(list[i][0] != '502'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>판매비와관리비</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }
                        total4 = parseInt(list[i][2])
                    }


                    {# 판매비와 관리비 밑에줄들 #}
                    for (var j = 0; j < list2.length; j++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list2[j][0] == '502' && list2[j][3] > 0){

                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>" + list2[j][2] + "</td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list2[j][3]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");


                            {#수정했음#}
                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list2[j][0]}_${list2[j][1]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                            }

                        }
                    }

                    {# 영업이익 #}
                    total5 = parseInt(total3) + parseInt(total4)
                    $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                    $("#sheetTb").append(
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'>영업이익</td> " +
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'></td> " +
                        "<td class='text-end border border-light text-info p-1 sale_revenue sale_revenue_sum' data-ym='sum' style='font-size: 0.85rem'>" + addComma(total5) + "</td> " +
                        "<td class='text-end border border-light text-info p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                    for (var d = 0; d < dates.length; d++) {
                        $("#sheetTb").append(
                            `<td class='text-end border border-light text-info p-1 sale_revenue sale_revenue_${dates[d]}' data-ym='${dates[d]}' style='font-size: 0.85rem'>0</td>
                            <td class='text-end border border-light text-info p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                    }

                    {# 영업외수익 #}
                    for (var i = 0; i < list.length; i++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list[i][0] == '402'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>영업외수익</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1 in_mng_fee in_mng_fee_sum' style='font-size: 0.85rem'>" + addComma(list[i][2]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 in_mng_fee in_mng_fee_${dates[d]} ${list[i][0]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }
                        if(list[i][0] != '402'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>영업외수익</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }

                        total6 = parseInt(list[i][2])
                    }


                    for (var j = 0; j < list2.length; j++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list2[j][0] == '402' && list2[j][6] > 0){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>" + list2[j][5] + "</td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list2[j][6]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list2[j][0]}_${list2[j][1]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                            }
                        }
                    }


                    {# 영업외비용 #}
                    for (var i = 0; i < list.length; i++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list[i][0] == '503'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>영업외비용</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1 out_mng_fee out_mng_fee_sum' style='font-size: 0.85rem'>-" + addComma(list[i][2]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 out_mng_fee out_mng_fee_${dates[d]} ${list[i][0]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }
                        if(list[i][0] != '503'){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>영업외비용</td> " +
                                "<td class='text-center border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>%</td> `);
                            }
                        }

                        total7 = parseInt(list[i][2])
                    }


                    for (var j = 0; j < list2.length; j++) {

                        $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                        if(list2[j][0] == '503' && list2[j][3] > 0){
                            $("#sheetTb").append(
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'></td> " +
                                "<td class='text-start border border-light text-dark p-1' style='font-size: 0.85rem'>" + list2[j][2] + "</td> " +
                                "<td class='text-end border border-light text-dark p-1' style='font-size: 0.85rem'>" + addComma(list2[j][3]) + "</td> " +
                                "<td class='text-end border border-light text-dark p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");


                            for (var d = 0; d < dates.length; d++) {
                                $("#sheetTb").append(
                                    `<td class='text-end border border-light text-dark p-1 ${list2[j][0]}_${list2[j][1]}_${dates[d]}' style='font-size: 0.85rem'>0</td>
                                     <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                            }
                        }
                    }

                    {# 순이익 #}
                    total8 = total5 + total6 - total7
                    $("#sheetTb").append("<tr id='#sheetTr' class='sheetTr_tr'>" + "</tr> ");
                    $("#sheetTb").append(
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'>순이익</td> " +
                        "<td class='text-center border border-light text-info p-1' style='font-size: 0.85rem'></td> " +
                        "<td class='text-end border border-light text-info p-1 profit_revenue profit_revenue_sum' data-ym='sum' style='font-size: 0.85rem'>" + addComma(total8) + "</td> " +
                        "<td class='text-end border border-light text-info p-1 sharerate' data-ym='sum' style='font-size: 0.85rem'>점유율</td> ");

                    for (var d = 0; d < dates.length; d++) {
                        $("#sheetTb").append(
                            `<td class='text-end border border-light text-dark p-1 profit_revenue profit_revenue_${dates[d]}' data-ym='${dates[d]}' style='font-size: 0.85rem'>합계</td>
                             <td class='text-end border border-light text-dark p-1 sharerate' data-ym='${dates[d]}' style='font-size: 0.85rem'>매출대비</td> `);
                    }

                    {#수정했음#}
                    for (var k = 0; k < list3.length; k++) {
                        $(`.${list3[k][0]}_${list3[k][3]}`).text(addComma(list3[k][2]));
                    }
                    for (var k = 0; k < list4.length; k++) {
                        $(`.${list4[k][0]}_${list4[k][1]}_${list4[k][4]}`).text(addComma(list4[k][3]));
                    }

                    $('.sale_revenue').each(function() {
                        var ym = $(this).data('ym');

                        var profit = parseInt($(`.profit_${ym}`).text().replaceAll(',', ''));
                        var sale_mng_fee = isNaN(parseInt($(`.sale_mng_fee_${ym}`).text())) ? 0 : parseInt($(`.sale_mng_fee_${ym}`).text().replaceAll(',', ''));

                        var sale_revenue = profit + sale_mng_fee;

                        $(this).text(addComma(sale_revenue));
                    });

                    $('.profit_revenue').each(function() {
                        var ym = $(this).data('ym');
                        var profit = 0;
                        var sale_mng_fee = 0;
                        var in_mng_fee = 0;
                        var out_mng_fee = 0;
                        var profit_revenue = 0;

                        if($(`.profit_${ym}`).length > 0)
                            profit = parseInt($(`.profit_${ym}`).text().replaceAll(',', ''));

                        if($(`.sale_mng_fee_${ym}`).length > 0)
                            sale_mng_fee = parseInt($(`.sale_mng_fee_${ym}`).text().replaceAll(',', ''));

                        if($(`.in_mng_fee_${ym}`).length > 0)
                            in_mng_fee = parseInt($(`.in_mng_fee_${ym}`).text().replaceAll(',', ''));

                        if($(`.out_mng_fee_${ym}`).length > 0)
                            out_mng_fee = parseInt($(`.out_mng_fee_${ym}`).text().replaceAll(',', ''));

                        profit_revenue = profit + sale_mng_fee + in_mng_fee - out_mng_fee;

                        $(this).text(addComma(profit_revenue));
                    });

                    {# 점유율 계산 #}
                    {#  각 항목의 합계에 매출액 합계로 나눠서 100 #}
                    $('.sharerate').each(function() {
                        var ym = $(this).data('ym');
                        var salesamount = 0;
                        var sub_sum = 0;
                        var sharerate = 0;

                        if($(`.salesamount_${ym}`).length > 0)
                            salesamount = parseInt($(`.salesamount_${ym}`).text().replaceAll(',', ''));

                        if($(this).prev())
                            sub_sum = parseInt($(this).prev().text().replaceAll(',', ''));

                        if(salesamount != 0)
                            sharerate = sub_sum / salesamount * 100;

                        $(this).text(addComma(sharerate.toFixed(2)) + '%');
                    });



                }
            });
        });


        function getYearMonthsBetween(start_dt, end_dt) {
            let startDate = new Date(start_dt);
            let endDate = new Date(end_dt);
            let dates = [];

            while (startDate <= endDate) {
                let year = startDate.getFullYear();
                let month = String(startDate.getMonth() + 1).padStart(2, '0');

                dates.push(`${year}${month}`);

                startDate.setMonth(startDate.getMonth() + 1);
            }

            return dates;
        }

    </script>
{% endblock %}