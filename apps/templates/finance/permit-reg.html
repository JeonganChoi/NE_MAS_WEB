{% extends "layouts/base.html" %}

{% block title %} 실행 관리 {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
    {#         style="background-image: url('/static/assets/img/header-blue-purple.jpg'); background-position: bottom;"#}
    <div class="height-100"
         style="background-image: url('/static/assets/img/header-blue-purple.jpg'); background-position: bottom;"></div>
    <div class="container-fluid py-1 my-2">
        <div class="row mt-n7">
            <div class="col-lg-12">
                <div class="card blur border border-white rounded-2 shadow-xs">
                    <div class="card-body pb-2">
                        <div class="row">
                            <div class="col-lg-6 col-6 text-start">
                                <h4 class="text-dark font-weight-bold"><i class="fas fa-credit-card fas-4 me-3"></i>시행
                                    관리</h4>
                            </div>
                            <!--<div class="col-lg-6 col-6 text-end">
                                <button type="button" class="btn btn-sm btn-primary text-white text-sm" id="btnSave" name="btnSave">저 장</button>
                                <button type="button" class="btn btn-sm btn-linkedin text-white text-sm" id="btnClear" name="btnClear">초기화</button>
                                <button type="button" class="btn btn-sm btn-light text-dark text-sm" id="btnDlt" name="btnDlt">삭제</button>
                            </div>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12 col-12">
                <div class="card border border-white shadow-xs">
                    <div class="card-header pb-0">
                        <div class="row p-0">
                            <div class="col-lg-2 col-2">
                                <div class="input-group shadow-none">
                                    <label class="me-3" style="font-size: 0.85rem; width: 5rem"><i class="fas fa-search me-2"></i>거래일자</label>
                                    <input class="form-control border border-light rounded-1 text-center me-2 w-20" type="date" name="inputDate" id="inputDate" style="height: 2rem; width: 10rem">
                                </div>
                            </div>
                            <div class="col-lg-2 col-2">
                                <div class="input-group shadow-none">
                                    <label class="me-3" style="font-size: 0.85rem; width: 5rem"><i class="fas fa-search me-2"></i>승인</label>
                                    <select class="form-control border border-light rounded-1 text-center p-1 w-20" name="inputPermit" id="inputPermit" style="height: 2rem; font-size: 0.8rem">
                                        <option value="">미시행</option>
                                        <option value="1">시행</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-2 col-2 text-end">
                                <button type="button" class="btn btn-sm btn-primary text-white" style="font-size: 0.8rem" id="btnSearch" name="btnSearch">
                                        <i class="fas fa-search me-2 fs-6"></i>조 회
                                </button>
                            </div>
                            <div class="col-lg-2 col-2">
                                <div class="input-group shadow-none">
                                    <label class="me-3" style="font-size: 0.85rem; width: 5rem"><i class="fas fa-search  me-2"></i>승인 일자</label>
                                    <input class="form-control border border-light rounded-1 text-center me-2 w-20" type="date" name="permitDate" id="permitDate" style="height: 2rem; width: 10rem">
                                </div>
                            </div>
                            <div class="col-lg-2 col-2">
                                <div class="input-group shadow-none">
                                    <label class="me-3" style="font-size: 0.85rem; width: 5rem"><i class="fas fa-search me-2"></i>계좌 번호</label>
                                    <select class="form-control border border-light rounded-1 text-center p-1 w-20" name="actNumber" id="actNumber" style="height: 2rem; font-size: 0.8rem"></select>
                                </div>
                            </div>
                            <div class="col-lg-2 col-2 text-end">
                                <button type="button" class="btn btn-sm text-white" style="background-color: darkgreen; font-size: 0.8rem" id="btnPermit" name="btnPermit">
                                    <i class="fas fa-file-signature me-2 fs-6"></i>승인
                                </button>
                            </div>
                        </div>
                        <div class="row p-0">
                            <div class="col-lg-2 col-2">
                                <div class="input-group shadow-none">
                                    <label class="me-3" style="font-size: 0.85rem; width: 5rem"><i class="fas fa-search me-2"></i>거래처</label>
                                    <select class="form-control border border-light rounded-1 text-center p-1 w-20" name="inputCust" id="inputCust" style="height: 2rem; font-size: 0.8rem"></select>
                                </div>
                            </div>
                            <div class="col-lg-2 col-2">
                                <div class="input-group shadow-none">
                                    <label class="" style="font-size: 0.85rem; width: 4rem"><i
                                            class="fas fa-star me-2"></i>상계</label>
                                    <input class="" value="off" type="checkbox" name="inputOffSet" id="inputOffSet"/>
                                </div>
                            </div>
                            <div class="col-lg-2 col-2"></div>
                            <div class="col-lg-2 col-2">
                                <div class="input-group shadow-none">
                                    <label class="me-3" style="font-size: 0.85rem; width: 5rem"><i
                                            class="fas fa-search  me-2"></i>상계 금액</label>
                                    <input class="form-control border border-light rounded-1 text-end me-2 w-20"
                                           type="text" name="CostOffSet" id="CostOffSet"
                                           style="height: 2rem; width: 10rem">
                                </div>
                            </div>
                            <div class="col-lg-2 col-2">
                                <label class="me-3" style="font-size: 0.85rem; width: 5rem" id="offLabel"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6 col-6">
                                <div class="table-responsive-sm height-400 overflow-auto border border-light">
                                    <table class="table mb-0 align-items-center justify-content-center" id="selectTb">
                                        <colgroup>
                                            <col width="3%">
                                            <col width="8%">
                                            <col width="15%">
                                            <col width="10%">
                                            <col width="10%">
                                            <col width="10%">
                                            <col hidden width="6%">
                                            <col width="6%">
                                            <col hidden width="6%">
                                            <col hidden width="6%">
                                        </colgroup>
                                        <thead class="text-white font-weight-bolder text-center"
                                               style="background-color: darkslateblue">
                                        <tr>
                                            <th style="font-size: 0.85rem" class="p-1">등록일자</th>
                                            <th style="font-size: 0.85rem" class="p-1">제 목</th>
                                            <th style="font-size: 0.85rem" class="p-1">계정 과목</th>
                                            <th style="font-size: 0.85rem" class="p-1">계좌번호</th>
                                            <th style="font-size: 0.85rem" class="p-1">금액</th>
                                            <th style="font-size: 0.85rem" class="p-1">작성자</th>
                                            <th style="font-size: 0.85rem" class="p-1">승인</th>
                                        </tr>
                                        </thead>
                                        <tbody id="mainTb">
                                        <tr id="#mainTr" class="mainTr_tr">

                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-2">
                                    <div class="row p-0">
                                        <div class="col-lg-8 col-8"></div>
                                        <div class="col-lg-4 col-4 text-end">
                                            <div class="input-group shadow-none">
                                                <label class="me-3" style="font-size: 0.85rem"><i
                                                        class="ni ni-money-coins me-2"></i>합계 금액</label>
                                                <input readonly
                                                       class="form-control border border-light rounded-1 text-end me-2 w-20"
                                                       type="text" name="inputPrice" id="inputPrice"
                                                       style="height: 2rem; width: 10rem">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-6">
                                <div class="table-responsive-sm height-400 overflow-auto border border-light">
                                    <table class="table mb-0 align-items-center justify-content-center" id="chkTb">
                                        <colgroup>
                                            <col width="8%">
                                            <col width="15%">
                                            <col width="10%">
                                            <col hidden width="6%">
                                            <col width="6%">
                                            <col hidden width="10%">
                                            <col hidden width="6%">
                                            <col width="10%">
                                        </colgroup>
                                        <thead class="text-white font-weight-bolder text-center"
                                               style="background-color: darkgreen">
                                        <tr>
                                            <th style="font-size: 0.85rem" class="p-1">승인일자</th>
                                            <th style="font-size: 0.85rem" class="p-1">제 목</th>
                                            <th style="font-size: 0.85rem" class="p-1">지출금액</th>
                                            <th style="font-size: 0.85rem" class="p-1">작성자</th>
                                            <th style="font-size: 0.85rem" class="p-1">계좌번호</th>
                                        </tr>
                                        </thead>
                                        <tbody id="subTb">
                                        <tr id="subTr" class="subTr_tr">

                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



{% endblock %}

{% block javascripts %}
    <script>
        $(document).ready(function () {

            var inputCust = "";
            var actNumber = "";
            var inputCustTxt = "<option value=''>:: 선택 ::</option>";
            var actNumberTxt = "";

            $("#inputCust").html("");
            $("#actNumber").html("");

            document.getElementById('inputDate').valueAsDate = new Date
            document.getElementById('permitDate').valueAsDate = new Date

            var pDate = document.getElementById('inputDate').value
            var perDate = pDate.replace(/\-/g, '')

            let data = {'perDate': perDate}

            $.ajax({
                type: "post",
                data: data,
                url: '{% url "permit_reg_search" %}',
                headers: {
                    'X-CSRFTOKEN': '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function (data) {
                    var list = data.mainList;

                    var total = 0;
                    {# 순번, 입.출금구분, 날짜 #}
                    $("#mainTb").html("");
                    for (var i = 0; i < list.length; i++) {
                        $("#mainTb").append(
                            "<tr id='#mainTr' class='mainTr_tr'>" +
                            "<td class='text-center p-2' style='font-size: 0.85rem'>" + list[i][0].replace(/(\d{4})(\d{2})(\d{2})/g, '$1-$2-$3') + "</td> " +
                            "<td class='text-start p-2' style='font-size: 0.85rem'>" + list[i][1] + "</td> " +
                            "<td class='text-start p-2' style='font-size: 0.85rem'>" + list[i][8] + "</td> " +
                            "<td class='text-start p-2' style='font-size: 0.85rem'>" + list[i][9] + "</td> " +
                            "<td class='text-end p-2' style='font-size: 0.85rem'>" + addComma(list[i][2]) + "</td> " +
                            "<td hidden class='text-start p-2' style='font-size: 0.85rem'>" + list[i][3] + "</td> " +
                            "<td class='text-start p-2' style='font-size: 0.85rem'>" + list[i][4] + "</td> " +
                            "<td hidden class='text-start p-2' style='font-size: 0.85rem'>" + list[i][5] + "</td> " +
                            "<td hidden class='text-start p-2' style='font-size: 0.85rem'>" + list[i][6] + "</td> " +
                            "<td class='text-center p-2' style='font-size: 0.85rem'><input class='' type='checkbox' id='chkPer[]' name='chkPer[]' value=''/></td> " +
                            "</tr> ");

                        total += Number(list[i][2])
                    }
                    document.getElementById('inputPrice').value = addComma(total)


                    var combolist = data.cboCust;
                    for (var i = 0; i < combolist.length; i++) {
                        if (combolist[i][0] == inputCust) {
                            inputCustTxt = inputCustTxt + "<option value='" + combolist[i][0] + "' selected>" + combolist[i][1] + "</option>";
                        } else {
                            inputCustTxt = inputCustTxt + "<option value='" + combolist[i][0] + "'>" + combolist[i][1] + "</option>";
                        }
                    }

                    var combolist2 = data.cboAct;
                    for (var i = 0; i < combolist2.length; i++) {
                        if (combolist2[i][0] == actNumber) {
                            actNumberTxt = actNumberTxt + "<option value='" + combolist2[i][0] + "' selected>" + combolist2[i][0] + "</option>";
                        } else {
                            actNumberTxt = actNumberTxt + "<option value='" + combolist2[i][0] + "'>" + combolist2[i][0] + "</option>";
                        }
                    }

                    $("#inputCust").append(inputCustTxt);
                    $("#actNumber").append(actNumberTxt);
                }
            })
        });


        $(document).on('change', '#selectTb tbody tr td:last-child input[type=checkbox]', function () {
            var tr = $(this).parent().parent();
            var iDate = tr.children().eq(0).text()
            var ioDate = iDate.replace(/\-/g, '')
            var acTitle = tr.children().eq(1).text()
            var acMcode = tr.children().eq(2).text()
            var acNum = tr.children().eq(3).text()
            var acAmts = tr.children().eq(4).text()
            var acEmp = tr.children().eq(5).text()
            var acNme = tr.children().eq(6).text()
            var acSeqn = tr.children().eq(7).text()
            var acIogb = tr.children().eq(8).text()

            var count = $(this).closest('tr').prevAll().length;

            var offTotal = 0;

            var offSet = $('input[name=inputOffSet]:checked').val();

            var pDate = document.getElementById('permitDate').value
            var perDate = pDate.replace(/\-/g, '')

            var cboActNum = "";
            var cboActNumTxt = "<option value=''>:: 선택 ::</option>";

            $("#cboActNum").html("");

            $.ajax({
                type: "post",
                url: '{% url "permit_cbo_search" %}',
                headers: {
                    'X-CSRFTOKEN': '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function (data) {
                    var combolist = data.cboActNum;
                    for (var i = 0; i < combolist.length; i++) {
                        if (combolist[i][0] == cboActNum) {
                            cboActNumTxt = cboActNumTxt + "<option value='" + combolist[i][0] + "' selected>" + combolist[i][0] + "</option>";
                        } else {
                            cboActNumTxt = cboActNumTxt + "<option value='" + combolist[i][0] + "'>" + combolist[i][0] + "</option>";
                        }
                    }

                    $("#cboActNum").append(cboActNumTxt);
                }
            })


            var total = 0;
            if ($(this).is(':checked')) {

                if ($('#subTr' + count).length == 0) {

                    var sub_tr_cnt = $('#chkTb tbody tr').length;

                    $("#subTb").append(
                        "<tr id='subTr" + count + "' class='subTr_tr'>" +
                        "<td class='text-center p-1' name='perDate'  id='perDate_" + (sub_tr_cnt) + "' style='font-size: 0.8rem'>" + perDate + "</td>" +
                        "<td hidden class='text-center p-1' name='ioDate'  id='ioDate_" + (sub_tr_cnt) + "' style='font-size: 0.8rem'>" + ioDate + "</td>" +
                        "<td class='text-start p-1' id='acTitle_" + (sub_tr_cnt) + "' style='font-size: 0.8rem'>" + acTitle + "</td> " +
                        "<td class='text-end p-1' id='acAmts_" + (sub_tr_cnt) + "' style='font-size: 0.8rem'>" + acAmts + "</td> " +
                        "<td hidden class='text-start p-1' name='acEmp'  id='acEmp_" + (sub_tr_cnt) + "' style='font-size: 0.8rem'>" + acEmp + "</td> " +
                        "<td class='text-start p-1' id='acNme_" + (sub_tr_cnt) + "' style='font-size: 0.8rem'>" + acNme + "</td> " +
                        "<td hidden class='text-start p-1' name='acSeqn'   id='acSeqn_" + (sub_tr_cnt) + "' style='font-size: 0.8rem'>" + acSeqn + "</td> " +
                        "<td hidden class='text-start p-1' name='acIogb'  id='acIogb_" + (sub_tr_cnt) + "' style='font-size: 0.8rem'>" + acIogb + "</td> " +
                        "<td class='text-center p-1' name='acNum'  id='acNum_" + (sub_tr_cnt) + "' style='font-size: 0.8rem'>" + acNum + "</td> " +
                        "</tr> ");

                {#    2. "상계 체크란이 체크됬을때만 "#}
                {#    acIogb 구분 값이 1이면 출금이라서 - 처리/ 2이면 입금이라서 + 처리 #}
{#                    단 계산해서 -값이더라도 -빼고 숫자만 상계금액에 보여주기#}

                    document.getElementById('CostOffSet').value = addComma(offTotal)


                }

            } else {

                document.getElementById('CostOffSet').value = addComma(offTotal)
                $('#subTr' + count).remove();
            }
        });

        {# 조회 버튼 #}
        $(document).on('click', "#btnSearch", function () {

            var sDate = document.getElementById('inputDate').value;
            var perDate = sDate.replace(/\-/g, '')
            var custCode = document.getElementById('inputCust').value;
            var offSet = $('input[name=inputOffSet]:checked').val();
            var permitGbn = document.getElementById('inputPermit').value;

            let data = {"perDate": perDate, "custCode": custCode, "offSet": offSet, "permitGbn": permitGbn}

            $.ajax({
                type: "post",
                data: data,
                url: '{% url "permit_reg_search" %}',
                headers: {
                    'X-CSRFTOKEN': '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function (data) {
                    var list = data.mainList;

                    var total = 0;
                    {# 순번, 입.출금구분, 날짜 #}
                    $("#mainTb").html("");
                    for (var i = 0; i < list.length; i++) {
                        $("#mainTb").append(
                            "<tr id='#mainTr' class='mainTr_tr'>" +
                            "<td class='text-center p-2' style='font-size: 0.85rem'>" + list[i][0].replace(/(\d{4})(\d{2})(\d{2})/g, '$1-$2-$3') + "</td> " +
                            "<td class='text-start p-2' style='font-size: 0.85rem'>" + list[i][1] + "</td> " +
                            "<td class='text-start p-2' style='font-size: 0.85rem'>" + list[i][8] + "</td> " +
                            "<td class='text-start p-2' style='font-size: 0.85rem'>" + list[i][9] + "</td> " +
                            "<td class='text-end p-2' style='font-size: 0.85rem'>" + addComma(list[i][2]) + "</td> " +
                            "<td hidden class='text-start p-2' style='font-size: 0.85rem'>" + list[i][3] + "</td> " +
                            "<td class='text-start p-2' style='font-size: 0.85rem'>" + list[i][4] + "</td> " +
                            "<td hidden class='text-start p-2' style='font-size: 0.85rem'>" + list[i][5] + "</td> " +
                            "<td hidden class='text-start p-2' style='font-size: 0.85rem'>" + list[i][6] + "</td> " +
                            "<td class='text-center p-2' style='font-size: 0.85rem'><input class='' type='checkbox' id='chkPer[]' name='chkPer[]' value=''/></td> " +
                            "</tr> ");


                    }

                    document.getElementById('inputPrice').value = addComma(total)
                }
            })

        });


        {# 승인 버튼 #}
        $(document).on('click', "#btnPermit", function () {

            {# 가로로 펼쳐진 td 갯수만큼 받아서 돌리기 #}
            const subCount = $('#subTb tr').length;
            var offSet = $('input[name=inputOffSet]:checked').val();
            var actNum = document.getElementById('actNumber').value;
            var perDate = document.getElementById('permitDate').value;

            var pmtArr = [];
            for (var i = 0; i < subCount; i++) {

                var perDate = $('#perDate_' + i).text();
                var ioDate = $('#ioDate_' + i).text();
                var acEmp = $('#acEmp_' + i).text();
                var acSeqn = $('#acSeqn_' + i).text();
                var acIogb = $('#acIogb_' + i).text();
                var acAmts = $('#acAmts_' + i).text();
                var acNum = $('#acNum_' + i).text();

                if (acNum == '' || acNum == null) {
                    acNum = document.getElementById('actNumber').value;
                }

                let chk = {"acNum": acNum}

                $.ajax({
                    type: "post",
                    data: chk,
                    url: '{% url "balanceChk" %}',
                    headers: {
                        'X-CSRFTOKEN': '{{ csrf_token }}'
                    },
                    dataType: 'json',
                    success: function (data) {
                        var act = "";
                        if (data.balance < acAmts) {
                            alert('선택한 통장의 잔고가 부족합니다.')
                            return;
                        }
                    }
                });

                let data = {
                    'perDate': perDate,
                    'ioDate': ioDate,
                    'acEmp': acEmp,
                    'acSeqn': acSeqn,
                    'acIogb': acIogb,
                    'acNum': acNum,
                    'acAmts': acAmts
                };
                pmtArr.push(data);
            }

            $.ajax({
                type: "post",
                data: {
                    'pmtArrList': JSON.stringify(pmtArr),
                    'offSet': offSet,
                    'actNum': actNum,
                    'perDate': perDate
                },
                dataType: "json",
                url: '{% url "permit_reg_save" %}',
                headers: {
                    'X-CSRFTOKEN': '{{ csrf_token }}'
                },
                success: function (data) {
                    if (data.sucYn === 'Y') {
                        alert('승인 되었습니다.')
                        location.href = "{% url 'permit_reg' %}";
                    }
                }
            });
        });

    </script>
{% endblock %}